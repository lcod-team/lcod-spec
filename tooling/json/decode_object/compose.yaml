compose:
  - call: lcod://tooling/value/default_object@0.1.0
    in:
      value: $.fallback
    out:
      fallbackObject: resolved

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.warningMessage
    out:
      warningProvided: ok

  - call: lcod://flow/if@1
    in:
      cond: $.warningProvided
    out:
      resolvedWarning: warning
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            warning: $.warningMessage
          out:
            warning: warning
      else:
        - call: lcod://impl/set@1
          in:
            warning: "Invalid JSON payload â€“ using fallback object."
          out:
            warning: warning

  - call: lcod://contract/core/json/decode@1
    in:
      text: $.text
    out:
      decodedValue: value
      decodeError: error

  - call: lcod://tooling/value/is_object@0.1.0
    in:
      value: $.decodedValue
    out:
      decodedIsObject: ok

  - call: lcod://tooling/value/is_object@0.1.0
    in:
      value: $.decodeError
    out:
      decodeErrorIsObject: ok

  - call: lcod://flow/if@1
    in:
      cond: $.decodedIsObject
    out:
      value: value
      warnings: warnings
      error: error
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            value: $.decodedValue
            warnings: []
            error: null
          out:
            value: value
            warnings: warnings
            error: error
      else:
        - call: lcod://flow/if@1
          in:
            cond: $.decodeErrorIsObject
          out:
            value: value
            warnings: warnings
            error: error
          slots:
            then:
              - call: lcod://impl/set@1
                in:
                  value: $.fallbackObject
                  warnings:
                    - $.resolvedWarning
                  error: $.decodeError
                out:
                  value: value
                  warnings: warnings
                  error: error
            else:
              - call: lcod://impl/set@1
                in:
                  value: $.fallbackObject
                  warnings:
                    - $.resolvedWarning
                  error:
                    message: "Decoded value is not an object"
                out:
                  value: value
                  warnings: warnings
                  error: error
