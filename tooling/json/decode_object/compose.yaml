compose:
  - call: lcod://tooling/value/default_object@0.1.0
    in:
      value: $.fallback
    out:
      fallbackObject: resolved

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.warningMessage
    out:
      warningProvided: ok

  - call: lcod://flow/if@1
    in:
      cond: $.warningProvided
    out:
      resolvedWarning: warning
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            warning: $.warningMessage
          out:
            warning: warning
      else:
        - call: lcod://impl/set@1
          in:
            warning: "Invalid JSON payload â€“ using fallback object."
          out:
            warning: warning

  - call: lcod://flow/try@1
    in:
      text: $.text
    out:
      value: value
      warnings: warnings
      error: error
    slots:
      body:
        - call: lcod://contract/core/json/decode@1
          in:
            text: $.text
          out:
            decoded: value
        - call: lcod://tooling/value/is_object@0.1.0
          in:
            value: $.decoded
          out:
            isObject: ok
        - call: lcod://flow/if@1
          in:
            cond: $.isObject
          out:
            normalizedValue: value
            normalizedWarnings: warnings
            normalizedError: error
          slots:
            then:
              - call: lcod://impl/set@1
                in:
                  value: $.decoded
                  warnings: []
                  error: null
                out:
                  value: value
                  warnings: warnings
                  error: error
            else:
              - call: lcod://impl/set@1
                in:
                  value: $.fallbackObject
                  warnings:
                    - $.resolvedWarning
                  error:
                    message: "Decoded value is not an object"
                out:
                  value: value
                  warnings: warnings
                  error: error
      catch:
        - call: lcod://impl/set@1
          in:
            value: $.fallbackObject
            warnings:
              - $.resolvedWarning
            error:
              message: $.error.message
          out:
            value: value
            warnings: warnings
            error: error
