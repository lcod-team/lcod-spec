compose:
  - call: lcod://tooling/script@1
    in:
      source: |
        async ({ state }) => {
          const normalize = (value) => {
            if (value === null || value === undefined) {
              return null;
            }
            if (typeof value !== "object") {
              return value;
            }
            if (Array.isArray(value)) {
              return value.map(normalize);
            }
            const entries = Object.keys(value)
              .sort()
              .map((key) => [key, normalize(value[key])]);
            return entries.reduce((acc, [key, val]) => {
              acc[key] = val;
              return acc;
            }, {});
          };

          try {
            const normalized = normalize(state.value);
            const text = JSON.stringify(normalized);
            return { text };
          } catch (err) {
            return { text: null, warning: err?.message || String(err) };
          }
        }
      input:
        value: $.value
    out:
      text: text
      warning: warning
