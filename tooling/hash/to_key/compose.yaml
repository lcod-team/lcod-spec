compose:
  - call: lcod://tooling/hash/sha256_base64@0.1.0
    in:
      data: $.text
    out:
      digest: base64

  - call: lcod://contract/core/string/format@1
    in:
      template: "{value}"
      values:
        value: $.prefix
      fallback: ""
    out:
      prefixTemplate: value

  - call: lcod://contract/core/string/trim@1
    in:
      text: $.prefixTemplate
    out:
      prefixNormalized: value

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.prefixNormalized
    out:
      prefixHasValue: ok

  - call: lcod://flow/if@1
    in:
      cond: $.prefixHasValue
    out:
      key: key
    slots:
      then:
        - call: lcod://contract/core/string/format@1
          in:
            template: "{prefix}{digest}"
            values:
              prefix: $.prefixNormalized
              digest: $.digest
            fallback: ""
          out:
            prefixedKey: value
        - call: lcod://impl/set@1
          in:
            key: $.prefixedKey
          out:
            key: key
      else:
        - call: lcod://impl/set@1
          in:
            key: $.digest
          out:
            key: key
